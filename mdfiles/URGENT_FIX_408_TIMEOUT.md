# üö® –°–†–û–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: 408 Request Timeout

## –ü—Ä–æ–±–ª–µ–º–∞
```
POST /api/upload HTTP/2.0" 408 0
readv() failed (104: Connection reset by peer)
SSL_read() failed
```

## –ü—Ä–∏—á–∏–Ω–∞
300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç) –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ 650MB + –Ω–µ –±—ã–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è HTTP/2.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ß—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ:

1. **–¢–∞–π–º–∞—É—Ç—ã —É–≤–µ–ª–∏—á–µ–Ω—ã —Å 300s –¥–æ 600s (10 –º–∏–Ω—É—Ç)** –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö
2. **–î–æ–±–∞–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–Ω—ã–µ HTTP/2 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**:
   - `http2_recv_timeout 600s` ‚≠ê –ö–õ–Æ–ß–ï–í–û–ï –¥–ª—è HTTP/2!
   - `http2_max_field_size 64k`
   - `http2_max_header_size 128k`
   - `http2_body_preread_size 128k`

3. **Next.js API route**: `maxDuration: 600` (–±—ã–ª–æ 300)

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- ‚úÖ `nginx.conf` - –≤—Å–µ —Ç–∞–π–º–∞—É—Ç—ã 600s + HTTP/2 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ `web/src/app/api/upload/route.ts` - maxDuration: 600
- ‚úÖ `web/vercel.json` - maxDuration: 600

---

## üöÄ –ë–´–°–¢–†–û–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–ï

### 1. –û–±–Ω–æ–≤–∏—Ç–µ Nginx –∫–æ–Ω—Ñ–∏–≥

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (SSH):

# –ë—ç–∫–∞–ø
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup_408

# –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π nginx.conf –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# (—á–µ—Ä–µ–∑ scp, ftp –∏–ª–∏ –∑–∞–º–µ–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é)

# –ü—Ä–æ–≤–µ—Ä–∫–∞
sudo nginx -t

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
sudo systemctl reload nginx

# –ò–ª–∏ –µ—Å–ª–∏ Docker:
docker cp nginx.conf nginx_container:/etc/nginx/nginx.conf
docker exec nginx_container nginx -t
docker restart nginx_container
```

### 2. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–¥–µ–ø–ª–æ–π—Ç–µ Next.js

```bash
# –ù–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:
cd web
npm run build

# –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–≥–æ setup):
# - –ï—Å–ª–∏ Docker: docker-compose up -d --build
# - –ï—Å–ª–∏ PM2: pm2 restart kinosite
# - –ï—Å–ª–∏ manual: –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π build –Ω–∞ —Å–µ—Ä–≤–µ—Ä
```

---

## üîç –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ nginx.conf

### –í —Å–µ–∫—Ü–∏–∏ `http`:
```nginx
# –ë–´–õ–û:
client_body_timeout 300s;
proxy_read_timeout 300s;
keepalive_timeout 65;
# –ù–ï –ë–´–õ–û HTTP/2 –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚ùå

# –°–¢–ê–õ–û:
client_body_timeout 600s;          # ‚úÖ 10 –º–∏–Ω—É—Ç
proxy_read_timeout 600s;           # ‚úÖ 10 –º–∏–Ω—É—Ç
send_timeout 600s;                 # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω
keepalive_timeout 600;             # ‚úÖ 10 –º–∏–Ω—É—Ç

# ‚≠ê HTTP/2 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ö–†–ò–¢–ò–ß–ù–û!)
http2_max_field_size 64k;
http2_max_header_size 128k;
http2_body_preread_size 128k;
http2_recv_timeout 600s;           # ‚≠ê‚≠ê‚≠ê –≠—Ç–æ —Ñ–∏–∫—Å–∏—Ç 408!
```

### –í —Å–µ–∫—Ü–∏–∏ `server`:
```nginx
# –ë–´–õ–û:
client_max_body_size 1024M;
client_body_timeout 300s;
client_header_timeout 300s;

# –°–¢–ê–õ–û:
client_max_body_size 1024M;
client_body_timeout 600s;          # ‚úÖ 10 –º–∏–Ω—É—Ç
client_header_timeout 600s;        # ‚úÖ 10 –º–∏–Ω—É—Ç
send_timeout 600s;                 # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω
keepalive_timeout 600;             # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω
http2_recv_timeout 600s;           # ‚≠ê‚≠ê‚≠ê –ö—Ä–∏—Ç–∏—á–Ω–æ!
```

### –í `location /api/upload`:
```nginx
# –ë–´–õ–û:
proxy_read_timeout 300s;
client_body_timeout 300s;
proxy_request_buffering off;

# –°–¢–ê–õ–û:
proxy_read_timeout 600s;           # ‚úÖ 10 –º–∏–Ω—É—Ç
proxy_connect_timeout 600s;        # ‚úÖ 10 –º–∏–Ω—É—Ç
proxy_send_timeout 600s;           # ‚úÖ 10 –º–∏–Ω—É—Ç
send_timeout 600s;                 # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω
client_body_timeout 600s;          # ‚úÖ 10 –º–∏–Ω—É—Ç
client_header_timeout 600s;        # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω

# ‚≠ê –£–ª—É—á—à–µ–Ω–Ω–∞—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è
proxy_request_buffering off;
proxy_buffering off;
proxy_buffer_size 128k;
proxy_buffers 8 128k;
proxy_busy_buffers_size 256k;
```

---

## ‚ö° –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–µ—à–∏—Ç –ø—Ä–æ–±–ª–µ–º—É

### –ü—Ä–æ–±–ª–µ–º–∞ #1: HTTP/2 timeout
**–û—à–∏–±–∫–∞:** `SSL_read() failed ... record layer failure`
**–†–µ—à–µ–Ω–∏–µ:** `http2_recv_timeout 600s` - Nginx —Ç–µ–ø–µ—Ä—å –∂–¥—ë—Ç 10 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö 30 —Å–µ–∫—É–Ω–¥

### –ü—Ä–æ–±–ª–µ–º–∞ #2: Connection reset
**–û—à–∏–±–∫–∞:** `readv() failed (104: Connection reset by peer)`
**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ —Ç–∞–π–º–∞—É—Ç—ã —É–≤–µ–ª–∏—á–µ–Ω—ã –¥–æ 600s - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —Ä–∞–∑–æ—Ä–≤—ë—Ç—Å—è —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏

### –ü—Ä–æ–±–ª–µ–º–∞ #3: 408 Request Timeout
**–û—à–∏–±–∫–∞:** `POST /api/upload HTTP/2.0" 408`
**–†–µ—à–µ–Ω–∏–µ:** `send_timeout 600s` + `keepalive_timeout 600` - Nginx –Ω–µ –∑–∞–∫—Ä–æ–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

---

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:
```bash
# Nginx –ª–æ–≥–∏
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log

# –ò–ª–∏ Docker:
docker logs -f nginx_container
```

### 2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ:
- –û—Ç–∫—Ä–æ–π—Ç–µ https://zabkinokom.ru/admin/site
- –ù–∞–∂–º–∏—Ç–µ "–í—ã–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ —Ñ–∞–π–ª"
- –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ 650MB
- –ñ–¥–∏—Ç–µ 5-10 –º–∏–Ω—É—Ç

### 3. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```bash
# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
POST /api/upload HTTP/2.0" 200 ...   # ‚úÖ 200 OK –≤–º–µ—Å—Ç–æ 408!
```

---

## üÜò –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 1: –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –µ—â—ë –±–æ–ª—å—à–µ
–í `nginx.conf` –∑–∞–º–µ–Ω–∏—Ç–µ `600s` –Ω–∞ `900s` (15 –º–∏–Ω—É—Ç) –∏–ª–∏ `1200s` (20 –º–∏–Ω—É—Ç)

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Docker memory limits
```bash
docker stats nextjs_container

# –ï—Å–ª–∏ –ø–∞–º—è—Ç—å –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ, —É–≤–µ–ª–∏—á—å—Ç–µ –≤ docker-compose.yml:
services:
  nextjs:
    deploy:
      resources:
        limits:
          memory: 4G  # –ë—ã–ª–æ 2G
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª 100MB:
dd if=/dev/zero of=/tmp/test100mb bs=1M count=100

# –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ curl:
time curl -F "files=@/tmp/test100mb" https://zabkinokom.ru/api/upload

# –ï—Å–ª–∏ –¥–æ–ª–≥–æ - –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏/–¥–∏—Å–∫–∞
```

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
–ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **Cloudflare R2** –∏–ª–∏ **AWS S3**:
1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ —Ç—É–¥–∞
2. –ü–æ–ª—É—á–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π URL
3. –í—Å—Ç–∞–≤—å—Ç–µ URL –≤ –ø–æ–ª–µ "URL –≤–∏–¥–µ–æ" –≤ –∞–¥–º–∏–Ω–∫–µ

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

- [ ] –ù–æ–≤—ã–π `nginx.conf` –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- [ ] `sudo nginx -t` –ø—Ä–æ—à—ë–ª –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω (`systemctl reload nginx`)
- [ ] Next.js –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω
- [ ] –°–∞–π—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è (https://zabkinokom.ru)
- [ ] –ü–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ 650MB
- [ ] –í –ª–æ–≥–∞—Ö –Ω–µ—Ç –æ—à–∏–±–æ–∫ 408
- [ ] –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å!

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–∏–¥–µ–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
–°–æ–∂–º–∏—Ç–µ 650MB ‚Üí 200-300MB:
```bash
ffmpeg -i input.mp4 -c:v libx264 -crf 23 -preset medium -vf scale=1920:-2 -c:a aac -b:a 128k output.mp4
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≥—Ä—É–∑–∫–∏
–î–æ–±–∞–≤—å—Ç–µ –≤ `nginx.conf` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:
```nginx
location /api/upload {
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ...
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    access_log /var/log/nginx/upload.log combined;
}
```

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 2025-10-16  
**–í–µ—Ä—Å–∏—è:** 2.0 (—Å HTTP/2 —Ñ–∏–∫—Å–∞–º–∏)  
**–ü—Ä–æ–±–ª–µ–º–∞:** 408 Request Timeout –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ 650MB  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ—à–µ–Ω–æ (600s —Ç–∞–π–º–∞—É—Ç—ã + HTTP/2 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)

