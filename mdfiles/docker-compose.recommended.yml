version: '3.8'

services:
  # ============================================
  # Next.js приложение с увеличенной памятью
  # ============================================
  nextjs:
    build: ./web
    container_name: nextjs_container
    restart: unless-stopped
    
    # ⭐ УВЕЛИЧИВАЕМ ПАМЯТЬ для обработки больших файлов
    deploy:
      resources:
        limits:
          memory: 2G        # Лимит памяти (минимум 2GB для 650MB файлов)
          cpus: '2.0'       # CPU лимит
        reservations:
          memory: 512M      # Зарезервированная память
    
    environment:
      - NODE_ENV=production
      # ⭐ Увеличиваем heap для Node.js
      - NODE_OPTIONS=--max-old-space-size=1536
      # Другие переменные окружения (замените на свои)
      - DATABASE_URL=${DATABASE_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
    
    volumes:
      # Монтируем папку uploads для сохранения файлов
      - ./web/public/uploads:/app/public/uploads
      # Можно добавить volume для логов
      - ./logs/nextjs:/app/logs
    
    networks:
      - app_network
    
    # Healthcheck для мониторинга
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Nginx прокси с увеличенными таймаутами
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: nginx_container
    restart: unless-stopped
    
    ports:
      - "80:80"
      - "443:443"
    
    volumes:
      # Монтируем обновлённый nginx.conf
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL сертификаты
      - ./ssl:/etc/nginx/ssl:ro
      # Статические файлы и uploads
      - ./web/public/uploads:/usr/share/nginx/html/uploads:ro
      # Логи Nginx (опционально)
      - ./logs/nginx:/var/log/nginx
    
    depends_on:
      - nextjs
    
    networks:
      - app_network
    
    # ⭐ Увеличиваем память для Nginx (опционально)
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  # ============================================
  # PostgreSQL база данных (если используется)
  # ============================================
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: postgres_container
  #   restart: unless-stopped
  #   
  #   environment:
  #     - POSTGRES_USER=kinosite
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
  #     - POSTGRES_DB=kinosite_db
  #   
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   
  #   networks:
  #     - app_network

networks:
  app_network:
    driver: bridge

# volumes:
#   postgres_data:

